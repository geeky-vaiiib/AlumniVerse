<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Session Diagnostic Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        .card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #3a3a3a;
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin: 5px 5px 5px 0;
        }
        .status.success {
            background: #10b981;
            color: #fff;
        }
        .status.error {
            background: #ef4444;
            color: #fff;
        }
        .status.warning {
            background: #f59e0b;
            color: #000;
        }
        .code-block {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #5568d3;
        }
        button:active {
            background: #4451b8;
        }
        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .test-result.pass {
            background: #10b98120;
            border-left-color: #10b981;
        }
        .test-result.fail {
            background: #ef444420;
            border-left-color: #ef4444;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #3a3a3a;
        }
        .metric-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê Supabase Session Diagnostic Tool</h1>
        <div class="subtitle">AlumniVerse - Session Persistence & Auth Flow Validator</div>
    </div>

    <div class="card">
        <h2>üìä Environment Check</h2>
        <div id="envCheck">Checking environment...</div>
    </div>

    <div class="card">
        <h2>üîç Session Status</h2>
        <div id="sessionStatus">
            <button onclick="checkSession()">üîÑ Check Current Session</button>
            <div id="sessionResult"></div>
        </div>
    </div>

    <div class="card">
        <h2>üíæ Local Storage Inspection</h2>
        <div id="storageStatus">
            <button onclick="checkStorage()">üîç Inspect Storage</button>
            <button onclick="clearStorage()">üóëÔ∏è Clear Storage</button>
            <div id="storageResult"></div>
        </div>
    </div>

    <div class="card">
        <h2>üß™ Session Persistence Tests</h2>
        <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
        <div id="testResults"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://flcgwqlabywhoulqalaz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsY2d3cWxhYnl3aG91bHFhbGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MDc3MDYsImV4cCI6MjA3NDQ4MzcwNn0.uWhtQvDUig4RTdxHZ_cdA3ajFbNUaEQ3oz8WYrV_R1g';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true,
                flowType: 'pkce',
                storage: window.localStorage,
                storageKey: 'sb-flcgwqlabywhoulqalaz-auth-token',
            }
        });

        window.supabase = supabase;

        // Check environment
        function checkEnvironment() {
            const envCheck = document.getElementById('envCheck');
            const checks = [
                { name: 'Supabase URL', value: SUPABASE_URL, valid: !!SUPABASE_URL },
                { name: 'Anon Key', value: SUPABASE_ANON_KEY.substring(0, 30) + '...', valid: !!SUPABASE_ANON_KEY },
                { name: 'localStorage Available', value: typeof window.localStorage !== 'undefined', valid: typeof window.localStorage !== 'undefined' }
            ];

            let html = '<div class="grid">';
            checks.forEach(check => {
                html += `
                    <div class="metric">
                        <div class="metric-label">${check.name}</div>
                        <div class="metric-value" style="color: ${check.valid ? '#10b981' : '#ef4444'}">
                            ${check.valid ? '‚úÖ' : '‚ùå'} ${check.value}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            envCheck.innerHTML = html;
        }

        // Check session
        window.checkSession = async function() {
            const result = document.getElementById('sessionResult');
            result.innerHTML = '<div class="loading"></div> Checking session...';

            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    result.innerHTML = `
                        <div class="test-result fail">
                            <strong>‚ùå Error</strong><br>
                            ${error.message}
                        </div>
                    `;
                    return;
                }

                if (!session) {
                    result.innerHTML = `
                        <div class="test-result fail">
                            <strong>‚ö†Ô∏è No Active Session</strong><br>
                            User is not logged in. Try logging in first.
                        </div>
                    `;
                    return;
                }

                const expiresAt = new Date(session.expires_at * 1000);
                const expiresIn = Math.floor((expiresAt - new Date()) / 1000 / 60);

                result.innerHTML = `
                    <div class="test-result pass">
                        <strong>‚úÖ Session Found!</strong><br><br>
                        <div class="grid">
                            <div class="metric">
                                <div class="metric-label">User ID</div>
                                <div class="metric-value" style="font-size: 14px">${session.user.id}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Email</div>
                                <div class="metric-value" style="font-size: 14px">${session.user.email}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Expires In</div>
                                <div class="metric-value">${expiresIn} min</div>
                            </div>
                        </div>
                        <div class="code-block">
                            <strong>Access Token:</strong><br>
                            ${session.access_token.substring(0, 50)}...<br><br>
                            <strong>Refresh Token:</strong><br>
                            ${session.refresh_token.substring(0, 50)}...
                        </div>
                    </div>
                `;
            } catch (err) {
                result.innerHTML = `
                    <div class="test-result fail">
                        <strong>‚ùå Unexpected Error</strong><br>
                        ${err.message}
                    </div>
                `;
            }
        };

        // Check storage
        window.checkStorage = function() {
            const result = document.getElementById('storageResult');
            const storageKey = 'sb-flcgwqlabywhoulqalaz-auth-token';
            const stored = localStorage.getItem(storageKey);

            if (!stored) {
                result.innerHTML = `
                    <div class="test-result fail">
                        <strong>‚ùå No Session in Storage</strong><br>
                        Key: <code>${storageKey}</code><br>
                        Session is not persisting to localStorage.<br><br>
                        <strong>This is likely why redirect loop occurs!</strong>
                    </div>
                `;
                return;
            }

            try {
                const data = JSON.parse(stored);
                result.innerHTML = `
                    <div class="test-result pass">
                        <strong>‚úÖ Session Persisted in localStorage!</strong><br><br>
                        <strong>Storage Key:</strong> <code>${storageKey}</code><br><br>
                        <div class="code-block">${JSON.stringify(data, null, 2)}</div>
                    </div>
                `;
            } catch (err) {
                result.innerHTML = `
                    <div class="test-result fail">
                        <strong>‚ùå Invalid Session Data</strong><br>
                        ${err.message}
                    </div>
                `;
            }
        };

        // Clear storage
        window.clearStorage = function() {
            if (confirm('Are you sure you want to clear all auth data?')) {
                localStorage.clear();
                document.getElementById('storageResult').innerHTML = `
                    <div class="test-result pass">
                        <strong>‚úÖ Storage Cleared</strong><br>
                        Refresh the page to see the effect.
                    </div>
                `;
            }
        };

        // Run all tests
        window.runAllTests = async function() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<div class="loading"></div> Running tests...';

            const tests = [];

            // Test 1: Session persistence
            try {
                const { data: { session } } = await supabase.auth.getSession();
                tests.push({
                    name: 'Session API Check',
                    pass: !!session,
                    message: session ? `Session found for ${session.user.email}` : 'No session found'
                });
            } catch (err) {
                tests.push({
                    name: 'Session API Check',
                    pass: false,
                    message: err.message
                });
            }

            // Test 2: Storage persistence
            const storageKey = 'sb-flcgwqlabywhoulqalaz-auth-token';
            const stored = localStorage.getItem(storageKey);
            tests.push({
                name: 'localStorage Persistence',
                pass: !!stored,
                message: stored ? 'Session data found in storage' : 'No session data in storage'
            });

            // Test 3: Token validation
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    tests.push({
                        name: 'Token Structure',
                        pass: !!(data.access_token && data.refresh_token),
                        message: 'Valid token structure'
                    });
                } catch (err) {
                    tests.push({
                        name: 'Token Structure',
                        pass: false,
                        message: 'Invalid JSON in storage'
                    });
                }
            }

            // Test 4: User data
            try {
                const { data: { user } } = await supabase.auth.getUser();
                tests.push({
                    name: 'User Data Fetch',
                    pass: !!user,
                    message: user ? `User ${user.email} authenticated` : 'No user data'
                });
            } catch (err) {
                tests.push({
                    name: 'User Data Fetch',
                    pass: false,
                    message: err.message
                });
            }

            // Render results
            let html = '<div style="margin-top: 20px">';
            const passedTests = tests.filter(t => t.pass).length;
            html += `<h3>Results: ${passedTests}/${tests.length} tests passed</h3>`;
            
            tests.forEach(test => {
                html += `
                    <div class="test-result ${test.pass ? 'pass' : 'fail'}">
                        <strong>${test.pass ? '‚úÖ' : '‚ùå'} ${test.name}</strong><br>
                        ${test.message}
                    </div>
                `;
            });
            html += '</div>';
            results.innerHTML = html;
        };

        // Auto-run on load
        checkEnvironment();
        checkSession();
        checkStorage();
    </script>
</body>
</html>
