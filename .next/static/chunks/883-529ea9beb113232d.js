"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[883],{1883:function(e,r,t){t.d(r,{AuthProvider:function(){return s},a:function(){return l}});var n=t(7437),o=t(2265),i=t(2427);let a=(0,o.createContext)({}),l=()=>{let e=(0,o.useContext)(a);if(!e)throw Error("useAuth must be used within an AuthProvider");return e};function s(e){let{children:r}=e,[t,l]=(0,o.useState)(null),[s,u]=(0,o.useState)(null),[c,d]=(0,o.useState)(!0),[h,f]=(0,o.useState)(!1);(0,o.useEffect)(()=>{let e=!0;f(!0),d(!1);let r=async(e,r)=>{try{console.log("Fetching profile for user:",e);let{data:t,error:n,status:o}=await i.OQ.from("users").select("*").eq("auth_id",e).maybeSingle();if(n&&406===o){console.warn("Profile not found (406), creating via server endpoint...");let t=await fetch("/api/profile/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({auth_id:e,email:r})});if(!t.ok){let e=await t.text();return console.error("Server profile creation failed:",e),null}let n=await t.json();return console.log("✅ Profile created via server endpoint"),n.data}if(n)return console.error("Profile fetch error:",n),null;if(t)return console.log("✅ Profile found in database"),t;console.log("No profile found, creating...");let a=await fetch("/api/profile/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({auth_id:e,email:r})});if(a.ok){let e=await a.json();return console.log("✅ Profile created successfully"),e.data}{let e=await a.text();return console.error("Profile creation failed:",e),null}}catch(e){return console.error("Profile fetch/create error:",e),null}},t=async()=>{try{let{data:{session:o},error:a}=await i.OQ.auth.getSession();if(e){if(a)console.error("Error getting session:",a),u(null),l(null);else{var t,n;u(o),l(null!==(n=null==o?void 0:o.user)&&void 0!==n?n:null),(null==o?void 0:null===(t=o.user)||void 0===t?void 0:t.id)&&r(o.user.id,o.user.email).catch(e=>{console.warn("Profile creation failed during initialization (non-critical):",e)})}}}catch(r){console.error("Session initialization error:",r),e&&(u(null),l(null))}};(async()=>{try{let{error:e}=await i.OQ.from("users").select("*").limit(1);e?console.warn("Supabase users table test failed (expected if auth_id column missing):",e.message):console.log("✅ Supabase users table reachable")}catch(e){console.warn("Supabase connection test error (non-critical):",e.message)}})(),t();let{data:{subscription:n}}=i.OQ.auth.onAuthStateChange(async(t,n)=>{if(e){var o,i,a,s;console.log("AuthProvider: Auth state change:",{event:t,hasSession:!!n,userEmail:null==n?void 0:null===(o=n.user)||void 0===o?void 0:o.email,userId:null==n?void 0:null===(i=n.user)||void 0===i?void 0:i.id,sessionExpiry:(null==n?void 0:n.expires_at)?new Date(1e3*n.expires_at).toISOString():"No expiry"}),u(n),l(null!==(s=null==n?void 0:n.user)&&void 0!==s?s:null),"SIGNED_IN"===t&&(null==n?void 0:null===(a=n.user)||void 0===a?void 0:a.id)&&(console.log("AuthProvider: User signed in, ensuring profile exists..."),r(n.user.id,n.user.email).catch(e=>{console.warn("Profile creation failed during sign-in (non-critical):",e)})),"SIGNED_OUT"===t&&console.log("AuthProvider: User signed out, clearing state")}});return()=>{e=!1,null==n||n.unsubscribe()}},[]);let g=async function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let{data:t,error:n}=await i.OQ.auth.signInWithOtp({email:e,options:{data:r,shouldCreateUser:!0}});if(n)throw n;return{data:t,error:null}}catch(e){return console.error("Sign up error:",e),{data:null,error:e}}},p=async e=>{try{let{data:r,error:t}=await i.OQ.auth.signInWithOtp({email:e,options:{shouldCreateUser:!1}});if(t)throw t;return{data:r,error:null}}catch(e){return console.error("Sign in with OTP error:",e),{data:null,error:e}}},w=async function(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{var n,o,a,l;let{data:s,error:u}=await i.OQ.auth.verifyOtp({email:e,token:r,type:"email"});if(u)throw u;let c=null!==(o=null==s?void 0:s.session)&&void 0!==o?o:null,d=null!==(a=null==c?void 0:c.user)&&void 0!==a?a:null;if(!d)throw Error("No user returned after OTP verification");await new Promise(e=>setTimeout(e,400));let{data:h}=await i.OQ.auth.getSession(),f=null!==(l=null==h?void 0:null===(n=h.session)||void 0===n?void 0:n.user)&&void 0!==l?l:d,{data:g,error:p}=await i.OQ.from("users").select("*").eq("auth_id",f.id).single();if(p&&("PGRST116"===p.code||404===p.status)){console.log("Profile not found, creating via server endpoint...");try{let e=await fetch("/api/profile/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(null==c?void 0:c.access_token)},body:JSON.stringify({auth_id:f.id,email:f.email,first_name:t.first_name||t.firstName||null,last_name:t.last_name||t.lastName||null,usn:t.usn||null,branch:t.branch||null,branch_code:t.branch_code||null,admission_year:t.admission_year||t.joining_year||null,passing_year:t.passing_year||null})});if(e.ok)console.log("Profile created successfully via server endpoint");else if(409===e.status)console.log("Profile already exists (expected on re-verification)");else{let r=await e.json();console.warn("Server profile creation failed:",r)}}catch(e){console.warn("Server profile creation error:",e)}}else g&&console.log("Profile found in database");return{data:s,error:null}}catch(e){return console.error("OTP verification error:",e),{data:null,error:e}}},v=async function(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{let{data:n,error:o}=await i.OQ.auth.signUp({email:e,password:r,options:{data:t}});if(o)throw o;return{data:n,error:null}}catch(e){return console.error("Sign up with password error:",e),{data:null,error:e}}},y=async(e,r)=>{try{let{data:t,error:n}=await i.OQ.auth.signInWithPassword({email:e,password:r});if(n)throw"invalid_credentials"!==n.code&&console.error("Sign in with password error:",n),n;return{data:t,error:null}}catch(e){return"invalid_credentials"!==e.code&&console.error("Password login error:",e),{data:null,error:e}}},S=async e=>{try{let{data:r,error:t}=await i.OQ.auth.resetPasswordForEmail(e,{redirectTo:"".concat(window.location.origin,"/reset-password")});if(t)throw t;return{data:r,error:null}}catch(e){return console.error("Reset password error:",e),{data:null,error:e}}},_=async e=>{try{let{data:r,error:t}=await i.OQ.auth.updateUser({password:e});if(t)throw t;return{data:r,error:null}}catch(e){return console.error("Update password error:",e),{data:null,error:e}}},m=async()=>{try{let{error:e}=await i.OQ.auth.signOut();if(e)throw e;return u(null),l(null),{error:null}}catch(e){return console.error("Sign out error:",e),{error:e}}};return(0,n.jsx)(a.Provider,{value:{user:t,session:s,loading:c,isReady:h,isLoggedIn:!!s,signUpWithOTP:g,signInWithOTP:p,verifyOTP:w,signUpWithPassword:v,signInWithPassword:y,resetPassword:S,updatePassword:_,signOut:m},children:r})}},2427:function(e,r,t){t.d(r,{OQ:function(){return a}});var n=t(3887);let o="https://flcgwqlabywhoulqalaz.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsY2d3cWxhYnl3aG91bHFhbGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MDc3MDYsImV4cCI6MjA3NDQ4MzcwNn0.uWhtQvDUig4RTdxHZ_cdA3ajFbNUaEQ3oz8WYrV_R1g",a=o&&i?(0,n.eI)(o,i,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"},global:{headers:{"X-Client-Info":"alumniverse-frontend"}}}):function(){let e=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"method";return async()=>({data:null,error:Error("Supabase is not configured. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in .env.local before using auth ".concat(e))})};return{auth:{getSession:e("getSession"),signInWithPassword:e("signInWithPassword"),signUp:e("signUp"),signInWithOtp:e("signInWithOtp"),resetPasswordForEmail:e("resetPasswordForEmail"),updateUser:e("updateUser"),verifyOtp:e("verifyOtp"),signOut:e("signOut"),onAuthStateChange:()=>({data:{subscription:{unsubscribe:()=>{}}}})}}}();o&&i?console.log("✅ Supabase client initialized successfully"):console.warn("⚠️ Supabase env not found. Define NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in .env.local")}}]);